---
import { themeConfig } from '@/config'
---

<script define:vars={{ copyCode: themeConfig.post.copyCode }}>
  const copyResetTimers = new WeakMap()

  async function writeToClipboard(text) {
    if (navigator.clipboard?.writeText) {
      try {
        await navigator.clipboard.writeText(text)
        return true
      } catch {}
    }

    try {
      const textArea = document.createElement('textarea')
      textArea.value = text
      textArea.style.position = 'fixed'
      textArea.style.opacity = '0'
      document.body.appendChild(textArea)
      textArea.focus()
      textArea.select()
      const ok = document.execCommand('copy')
      document.body.removeChild(textArea)
      return ok
    } catch {
      return false
    }
  }

  function initCopyCode() {
    const copyIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path>
        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path>
      </svg>
    `

    const copiedIcon = `
      <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="none">
        <path class="checkmark-path" d="M3.5 8.5L6.5 11.5L12.5 5.5" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    `

    document.body.setAttribute('data-copy-code', copyCode ? 'enabled' : 'disabled')

    if (!copyCode) {
      return
    }

    const copyButtons = document.querySelectorAll('.copy-button')

    copyButtons.forEach((button) => {
      // Avoid initializing multiple times (important for SPA navigation)
      if (button.dataset.copyInit) return
      button.dataset.copyInit = '1'

      // Find the closest pre element with the .copy-code-block class
      let preElement = button.closest('.copy-code-block')
      if (!preElement) {
        const parent = button.parentElement
        if (parent) {
          preElement = parent.querySelector('.copy-code-block')
        }
      }
      if (!preElement) return

      const codeElement = preElement.querySelector('code')
      if (!codeElement) return

      if (!button.querySelector('svg')) {
        button.innerHTML = copyIcon
      }

      button.setAttribute('aria-label', 'Copy code')

      const refreshIconRefs = () => {
        const icons = button.querySelectorAll('svg')
        icons.forEach((icon) => {
          icon.classList.remove('is-entering', 'is-exiting')
        })
        const currentIcon = button.querySelector('svg')
        if (currentIcon) {
          currentIcon.classList.add('is-entering')
        }
      }

      refreshIconRefs()

      // Determine the container to attach hover events
      let container = preElement
      const parent = button.parentElement
      if (parent && parent.classList.contains('copy-code-wrapper')) {
        container = parent
      }

      container.addEventListener('mouseenter', () => {
        button.classList.add('is-visible')
      })

      container.addEventListener('mouseleave', () => {
        if (!button.hasAttribute('data-copying')) {
          button.classList.remove('is-visible')
        }
      })

      button.addEventListener('focus', () => {
        button.classList.add('is-visible')
      })

      button.addEventListener('blur', () => {
        if (!button.hasAttribute('data-copying')) {
          button.classList.remove('is-visible')
        }
      })

      button.addEventListener('click', async () => {
        const codeText = codeElement.textContent || ''
        const didCopy = await writeToClipboard(codeText)
        if (!didCopy) {
          console.error('Failed to copy code')
        }

        const existingTimer = copyResetTimers.get(button)
        if (existingTimer) {
          clearTimeout(existingTimer)
        }

        button.setAttribute('data-copying', 'true')
        button.setAttribute('aria-label', 'Copied')
        button.classList.add('is-visible')
        button.classList.remove('is-copied')
        void button.offsetWidth
        button.classList.add('is-copied')
        button.innerHTML = copiedIcon
        refreshIconRefs()

        const resetTimer = window.setTimeout(() => {
          if (!container.matches(':hover') && !button.matches(':focus-visible')) {
            button.classList.remove('is-visible')
          }
          button.removeAttribute('data-copying')
          button.classList.remove('is-copied')
          button.innerHTML = copyIcon
          button.setAttribute('aria-label', 'Copy code')
          refreshIconRefs()
          copyResetTimers.delete(button)
        }, 1200)

        copyResetTimers.set(button, resetTimer)
      })
    })
  }

  // Use only astro:page-load as it fires on initial load and navigation
  document.addEventListener('astro:page-load', () => {
    initCopyCode()
  })
</script>

<style is:inline>
  /* Ensure the positioned ancestor is correct */
  .copy-code-wrapper {
    position: relative !important;
  }

  /* Keep for backward compatibility */
  .copy-code-block {
    position: relative !important;
  }

  .copy-button {
    position: absolute;
    top: 0.4rem;
    right: 0.4rem;
    width: 1.75rem;
    height: 1.75rem;
    z-index: 10;
    background: color-mix(in srgb, var(--astro-code-background) 75%, var(--bg) 25%);
    border-radius: 0.35rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: opacity 0.2s ease-out, transform 0.25s ease-out, color 0.2s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    backdrop-filter: blur(12px);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-4px);
    will-change: opacity, transform;
  }

  .copy-button.is-visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .copy-button.is-copied {
    animation: copy-pop 0.35s ease-out;
  }

  @keyframes copy-pop {
    0% {
      transform: translateY(0) scale(1);
    }
    40% {
      transform: translateY(0) scale(1.06);
    }
    100% {
      transform: translateY(0) scale(1);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .copy-button {
      transition: opacity 0.2s ease-out, color 0.2s ease-out;
    }

    .copy-button.is-copied {
      animation: none;
    }

    .copy-button svg.is-entering {
      animation: none;
    }

    .copy-button svg.check-icon .checkmark-path {
      animation: none;
      stroke-dashoffset: 0;
    }
  }

  body[data-copy-code='disabled'] .copy-button {
    display: none !important;
  }

  .copy-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--code-bg);
    border-radius: 0.325rem;
    opacity: 0;
    transition: opacity 0.15s ease-out;
    pointer-events: none;
  }

  .copy-button:hover::before {
    opacity: 1;
  }

  .copy-button:hover {
    color: var(--text-primary);
  }

  .copy-button svg {
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    opacity: 0.85;
    transition: opacity 0.2s ease-out;
  }

  .copy-button svg.is-entering {
    animation: icon-in 0.35s ease-out;
  }

  .copy-button svg.check-icon .checkmark-path {
    stroke-dasharray: 24;
    stroke-dashoffset: 24;
  }

  .copy-button svg.check-icon.is-entering .checkmark-path {
    animation: check-draw 0.5s ease-out forwards;
  }

  @keyframes check-draw {
    from {
      stroke-dashoffset: 24;
    }
    to {
      stroke-dashoffset: 0;
    }
  }

  @keyframes icon-in {
    from {
      transform: translateY(2px) scale(0.96);
      opacity: 0.3;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 0.85;
    }
  }
</style>
