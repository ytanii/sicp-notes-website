---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig } from '@/config'

interface ExtendedPostLayoutProps extends PostLayoutProps {
  chapter?: number
  section?: number
}

const { title, readingTime, toc, chapter, section } = Astro.props as ExtendedPostLayoutProps

const displayTitle = title
const titleNumber = chapter ? (section ? `${chapter}.${section}` : `${chapter}`) : ''
const titleNumberClass = chapter ? (section ? 'title-number is-section' : 'title-number is-chapter') : ''

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout
  title={`${displayTitle} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
>
  <BaseHead
    title={`${displayTitle} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main id="main-content" tabindex="-1">
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <div class="title-row">
            <h1>{displayTitle}</h1>
            {titleNumber && <div class={titleNumberClass}>{titleNumber}</div>}
          </div>
          {themeConfig.post.readingTime && readingTime && (
            <div class="reading-time">{readingTime.text}</div>
          )}
        </div>
        <article class="content">
          <slot />
        </article>
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }
</style>

<script>
  // Convert imports sections to collapsible details/summary with structured list
  function styleImportsSections() {
    const prose = document.querySelector('.prose .content')
    if (!prose) return

    const paragraphs = prose.querySelectorAll('p')
    paragraphs.forEach((p) => {
      // Skip if already processed
      if (p.dataset.importsProcessed) return

      const firstChild = p.firstElementChild
      if (firstChild?.tagName === 'EM') {
        const text = firstChild.textContent?.trim() || ''
        if (text === 'Imports' || text.startsWith('Imports:') || text === 'Imports:') {
          p.dataset.importsProcessed = 'true'

          // Create details/summary structure
          const details = document.createElement('details')
          details.className = 'imports-section'

          const summary = document.createElement('summary')
          summary.textContent = 'Imports'

          // Create list for imports
          const list = document.createElement('ul')
          list.className = 'imports-list'

          // Collect nodes after the "Imports:" label
          const nodes = Array.from(p.childNodes).slice(1) // Skip the first em

          // Parse into groups separated by commas
          let currentGroup = document.createElement('li')
          let hasContent = false

          nodes.forEach((node) => {
            if (node.nodeType === 3) {
              // Text node - check for comma separator
              const text = node.textContent || ''
              if (text.includes(',')) {
                // Split by comma
                const parts = text.split(',')
                parts.forEach((part, i) => {
                  if (part.trim()) {
                    currentGroup.appendChild(document.createTextNode(part.trim() + ' '))
                    hasContent = true
                  }
                  if (i < parts.length - 1 && hasContent) {
                    // Comma found - end current group, start new one
                    list.appendChild(currentGroup)
                    currentGroup = document.createElement('li')
                    hasContent = false
                  }
                })
              } else if (text.trim() && text.trim() !== ':') {
                currentGroup.appendChild(document.createTextNode(text))
                hasContent = true
              }
            } else {
              // Element node (link or code)
              currentGroup.appendChild(node.cloneNode(true))
              hasContent = true
            }
          })

          // Add the last group if it has content
          if (hasContent && currentGroup.childNodes.length > 0) {
            list.appendChild(currentGroup)
          }

          details.appendChild(summary)
          details.appendChild(list)

          // Replace the paragraph with the details element
          p.replaceWith(details)
        }
      }
    })
  }

  function handlePostPageLoad() {
    styleImportsSections()
  }

  handlePostPageLoad()

  if (!document.documentElement.hasAttribute('data-post-layout-bound')) {
    document.documentElement.setAttribute('data-post-layout-bound', '1')
    document.addEventListener('astro:page-load', handlePostPageLoad)
  }
</script>
