---
import IndexLayout from '@/layouts/IndexLayout.astro'
import About from '@/components/widgets/About.astro'
import { ChapterList } from '@/components/react/ChapterList'
import { themeConfig } from '@/config'
import { getCollection } from 'astro:content'

const allNotes = await getCollection('notes')

// Separate chapters, sections, and exercises
const chapters = allNotes
  .filter(
    (note) =>
      note.data.chapter && !note.data.section && note.data.docType !== 'exercise' && !note.id.includes('/exercises/')
  )
  .sort((a, b) => (a.data.chapter || 0) - (b.data.chapter || 0))

const sections = allNotes
  .filter(
    (note) =>
      note.data.chapter && note.data.section && note.data.docType !== 'exercise' && !note.id.includes('/exercises/')
  )
  .sort((a, b) => {
    if (a.data.chapter !== b.data.chapter) {
      return (a.data.chapter || 0) - (b.data.chapter || 0)
    }
    return (a.data.section || 0) - (b.data.section || 0)
  })

const exercises = allNotes
  .filter((note) => note.data.docType === 'exercise' || note.id.includes('/exercises/'))
  .sort((a, b) => {
    if (a.data.chapter !== b.data.chapter) {
      return (a.data.chapter || 0) - (b.data.chapter || 0)
    }
    return (a.data.section || 0) - (b.data.section || 0)
  })

// Group sections by chapter
const sectionsByChapter = sections.reduce(
  (acc, section) => {
    const chapterNum = section.data.chapter || 0
    if (!acc[chapterNum]) acc[chapterNum] = []
    acc[chapterNum].push(section)
    return acc
  },
  {} as Record<number, typeof sections>
)

// Group exercises by chapter
const exercisesByChapter = exercises.reduce(
  (acc, exercise) => {
    const chapterNum = exercise.data.chapter || 0
    if (!acc[chapterNum]) acc[chapterNum] = []
    acc[chapterNum].push(exercise)
    return acc
  },
  {} as Record<number, typeof exercises>
)
---

<IndexLayout title={themeConfig.site.title} description={themeConfig.site.description}>
  <div class="puddle-overlay" aria-hidden="true">
    <div class="puddle-container"></div>
  </div>
  <About />
  <main>
    <div class="chapter-list-container">
      <ChapterList
        client:load
        chapters={chapters}
        sectionsByChapter={sectionsByChapter}
        exercisesByChapter={exercisesByChapter}
      />
    </div>
  </main>
  <script type="module" src="/scripts/puddle.js"></script>
</IndexLayout>

<style>
  :global(.page-content) {
    position: relative;
    z-index: 1;
  }

  .chapter-list-container {
    position: relative;
  }

  .puddle-overlay {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
    --puddle-cutout: min(100vw, var(--content-width));
    --puddle-left: calc(50% - (var(--puddle-cutout) / 2));
    --puddle-right: calc(50% + (var(--puddle-cutout) / 2));
    -webkit-mask-image: linear-gradient(
      to right,
      #000 0,
      #000 var(--puddle-left),
      transparent var(--puddle-left),
      transparent var(--puddle-right),
      #000 var(--puddle-right),
      #000 100%
    );
    mask-image: linear-gradient(
      to right,
      #000 0,
      #000 var(--puddle-left),
      transparent var(--puddle-left),
      transparent var(--puddle-right),
      #000 var(--puddle-right),
      #000 100%
    );
    -webkit-mask-size: 100% 100%;
    mask-size: 100% 100%;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
  }

  .puddle-container {
    display: grid;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    font-family: var(--mono);
    font-size: 1.2rem;
    line-height: 1;
    color: var(--text-secondary);
    opacity: 0.9;
    user-select: none;
    pointer-events: none;
  }

  .puddle-container span {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (prefers-reduced-motion: reduce) {
    .puddle-overlay {
      display: none;
    }
  }

  .chapter-list-container::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: -0.9rem;
    width: 1px;
    background: var(--border);
    opacity: 0.6;
    pointer-events: none;
  }
</style>
