---
import IndexLayout from '@/layouts/IndexLayout.astro'
import About from '@/components/widgets/About.astro'
import { ChapterList } from '@/components/react/ChapterList'
import { themeConfig } from '@/config'
import { getCollection } from 'astro:content'

const allNotes = await getCollection('notes')

// Separate chapters, sections, and exercises
const chapters = allNotes
  .filter(
    (note) =>
      note.data.chapter && !note.data.section && note.data.docType !== 'exercise' && !note.id.includes('/exercises/')
  )
  .sort((a, b) => (a.data.chapter || 0) - (b.data.chapter || 0))

const sections = allNotes
  .filter(
    (note) =>
      note.data.chapter && note.data.section && note.data.docType !== 'exercise' && !note.id.includes('/exercises/')
  )
  .sort((a, b) => {
    if (a.data.chapter !== b.data.chapter) {
      return (a.data.chapter || 0) - (b.data.chapter || 0)
    }
    return (a.data.section || 0) - (b.data.section || 0)
  })

const exercises = allNotes
  .filter((note) => note.data.docType === 'exercise' || note.id.includes('/exercises/'))
  .sort((a, b) => {
    if (a.data.chapter !== b.data.chapter) {
      return (a.data.chapter || 0) - (b.data.chapter || 0)
    }
    return (a.data.section || 0) - (b.data.section || 0)
  })

// Group sections by chapter
const sectionsByChapter = sections.reduce(
  (acc, section) => {
    const chapterNum = section.data.chapter || 0
    if (!acc[chapterNum]) acc[chapterNum] = []
    acc[chapterNum].push(section)
    return acc
  },
  {} as Record<number, typeof sections>
)

// Group exercises by chapter
const exercisesByChapter = exercises.reduce(
  (acc, exercise) => {
    const chapterNum = exercise.data.chapter || 0
    if (!acc[chapterNum]) acc[chapterNum] = []
    acc[chapterNum].push(exercise)
    return acc
  },
  {} as Record<number, typeof exercises>
)
---

<IndexLayout title={themeConfig.site.title} description={themeConfig.site.description}>
  <About />
  <main>
    <div class="chapter-list-container">
      <ChapterList
        client:load
        chapters={chapters}
        sectionsByChapter={sectionsByChapter}
        exercisesByChapter={exercisesByChapter}
      />
    </div>
  </main>
</IndexLayout>

<style>
  .chapter-list-container {
    position: relative;
  }

  .chapter-list-container::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: -0.9rem;
    width: 1px;
    background: var(--border);
    opacity: 0.6;
    pointer-events: none;
  }

  .chapter-list-container::after {
    content: '';
    position: absolute;
    left: -0.9rem;
    width: 1px;
    height: 32%;
    top: 0;
    background: linear-gradient(to bottom, transparent, var(--text-tertiary), transparent);
    opacity: 0.7;
    pointer-events: none;
    animation: guide-scan 6s linear infinite;
  }

  @keyframes guide-scan {
    0% {
      opacity: 0;
      transform: translateY(-35%);
    }
    10% {
      opacity: 0.7;
    }
    90% {
      opacity: 0.7;
      transform: translateY(135%);
    }
    100% {
      opacity: 0;
      transform: translateY(155%);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .chapter-list-container::after {
      animation: none;
      opacity: 0;
    }
  }
</style>
